---
title: "Optimising Google Fonts for Increased Performance on GatsbyJS."
description: "GatsbyJS makes blazing fasts websites already but often importing fonts can be the achilles heel, here's how to optimise Google Fonts for increased performance."
date: "2020-06-02"
category: "Let's Code"
languages: ["GatsbyJS"]
slug: optimising-google-fonts-gatsby-increased-performance
image: 
id: 11
---

## The Problem

Google Fonts is awesome, it has loads of great free fonts for anyone to use pretty much however they wish. But, even with all of this goodness there is one issue we can't escape, Google Fonts can be incredibly taxing on your website's load time. Sometimes, we can measuring the impact of Google Fonts loading in seconds rather than milliseconds which in today's world where your entire site and business can be penalised for slow load times, this is a big deal.

Recently after redesigning my portfolio site, I spent a good few days trying to come up with an adequate solution to this issue and it this solution that I'm going to share with you today. 

### How to not import fonts to Gatsby

First, let's take a look at how we should not be importing Google Fonts. 

```html
<style>
@import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
</style> 
```

Google lists using '@import' as one of the main ways of importing their fonts onto your site and while it is very user friendly, it comes with it's issues. To show these issues, let's take a look at some statistics of this site:

| Device                | @import | My Solution |
|-----------------------|---------|-------------|
| Desktop - no throttle | 3.5     | 2.6         |
| Mobile - throttled    | 3.2     | 2.7         |

So, as you can see the '@import' method while great for convenience and user friendliness isn't the best when it comes to performance. So, let's now look at some other methods for integrating Google Fonts onto your GatsbyJS site.

## Possible solutions

Here are some possible solutions that were things I experimented with before arriving at my current solution.

### gatsby-plugin-google-fonts

First, we have the Google Fonts plugin for GatsbyJS, you can find the plugins documentation page [here](https://www.gatsbyjs.org/packages/gatsby-plugin-google-fonts/). 

What this plugin allows you to do is define the fonts you want to use on your site in your 'gatsby-config.js' file and then when you build your website it will download the fonts and serve them to you from the server along with your site. 

This plugin is a step in the right direction but increases the build time of your site plus it increases the bundle size of your site which isn't great either. Ultimately, we want to try keep the amount of external packages to a minimum as this increases both our page load time and build time. 

So, while this plugin was a good option, it doesn't quite make the cut.

### Typefaces

Now, this is an interesting option available to us, developed by Kyle Mathews (the guy behind GatsbyJS) it aims to solve some of the problems the previous plugin gives while keeping all of the good bits. 

So, what you need to do is find the typeface npm package for the font you want to use, so for our example earlier of importing 'Roboto', we would use the package:

```
typeface-roboto
```

Once, we know the package we want to use we just need to install this package to our project and then require the files in our project which for gatsby can be done in the 'gatsby-browser.js' file.

To install the package use:

```
npm i typeface-roboto
```

Then just require it in your 'gatsby-browser.js' file by using:

```
require('typeface-roboto')
```

Now, this package removes the need to download the files each time we build the site, cutting down a lot on our total build time while also keeping the benefits of hosting the files locally and serving them alongside our website decreasing the total time our users need to wait for our site to load. 

But, there is still the issue of it being an external package being called in our code. But, what if we could create the benefits of both of these packages without needing to use either them. Essentially, could we host our fonts locally on our site, serve them with our site without having to download them each time and without having to use an external package.

And, the answer is YES! Obviously... Otherwise, why would I be writing this...

## External Package Free Solution - My Solution

You see when we use the '@import' from earlier all it is doing is calling an API to access all of the files it needs to download via their own respective URLs. We can see this in action if we navigate to the URL we are calling the '@import' on. For example, the URL imported earlier returns:

[!Google Fonts API Files Gif](./static/gifs/11-GoogleFontsAPI.gif)

Now, we know why using '@import' can have such an impact on our page load times because not only do we need to wait for an API to reply with the relevant URLs, we also need to wait for the users browser to download each of these files. So, even though on Google Fonts' website we are only selecting 3 fonts, in reality we are downloading 21 files when the page loads and this takes up a lot of precious time. 

Lucky for us though there is a way to avoid this.

You see in this list we are actually calling multiple of the same font and font weight but with different language character supports depending on the languages of your audience you may or may not need to support these extra characters. I know the overwhelming majority of my audience can be supported by using the 'Latin' typeface but you may need more.

### Downloading the Fonts

So, what we're going to do is download the files we need by accessing the URL contained within the url value inside of the src property on each of the font-face objects we require for our site. For our example, we would need to use the following 3 font-faces and the urls contained within them:

```JavaScript{7,17,27}
/* latin */
@font-face {
  font-family: 'Roboto';
  font-style: normal;
  font-weight: 400;
  font-display: swap;
  src: local('Roboto'), local('Roboto-Regular'), url(https://fonts.gstatic.com/s/roboto/v20/KFOmCnqEu92Fr1Mu4mxK.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

/* latin */
@font-face {
  font-family: 'Roboto';
  font-style: normal;
  font-weight: 500;
  font-display: swap;
  src: local('Roboto Medium'), local('Roboto-Medium'), url(https://fonts.gstatic.com/s/roboto/v20/KFOlCnqEu92Fr1MmEU9fBBc4.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}

/* latin */
@font-face {
  font-family: 'Roboto';
  font-style: normal;
  font-weight: 700;
  font-display: swap;
  src: local('Roboto Bold'), local('Roboto-Bold'), url(https://fonts.gstatic.com/s/roboto/v20/KFOlCnqEu92Fr1MmWUlfBBc4.woff2) format('woff2');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
}
```

When we visit each of those urls, we download a font file that relates to the font-face object for that url. I would recommend renaming these files to something else a bit more user-friendly like 'Roboto-Regular' and so on for each font weight. 

### Importing to our Gatsby Site.

To import our fonts into our GatsbyJS project, we need to move the files into our project files, and check them into our git repository so they are committed with the rest of our project. This can be in any location of our choosing but I choose to put my files in the following location:

```
/
    /src
        /assets
            /fonts
                ...files here
```

Once you have moved your files into a location and checked them into your repository then we can move onto using our new fonts.

### Using our new fonts

To use your fonts in your styling, we need to create the font-faces for our fonts. This can either be done inside a global css file or if you're using Styled Components you can call the 'createGlobalStyle' API exported from Styled Components. With this API we can create global styles from inside a component. 

#### Styled Components

If you're using Styled Components you can use the same code I used and change it for your needs. To do this, we need to create a new Fonts component in the same location as your other components. Once you have created this file, drop the below code into it:

```JavaScript
import { createGlobalStyle } from 'styled-components';

const RobotoRegular = 'src/assets/fonts/Roboto-Regular.woff2';
const RobotoMedium= 'src/assets/fonts/Roboto-Medium.woff2';
const RobotoBold = 'src/assets/fonts/Roboto-Bold.woff2';

const Fonts = createGlobalStyle`
  @font-face {
    font-family: 'Roboto';
    src: url(${RobotoRegular}) format('woff2');
    font-weight: 400;
    font-style: normal;
  }
  @font-face {
    font-family: 'Roboto';
    src: url(${RobotoMedium}) format('woff2');
    font-weight: 500;
    font-style: normal;
  } 
  @font-face {
    font-family: 'Roboto';
    src: url(${RobotoBold}) format('woff2');
    font-weight: 700;
    font-style: normal;
  }
`;

export default Fonts;

```

You can change the configuration of this component to match all of the fonts you need installed on your site, you need to have one '@font-face' object per font per font weight.

Once you have imported all of your fonts and created a font face for all of them we then need to go to your layout.js file (or, whatever your template file is) and then import the fonts component to the page. This will ensure the fonts are imported to the page and the global styles are created. 

To import them to your layout.js file use:

```JavaScript
import Fonts from './Fonts';
```

Then just include a reference to this component inside your returned component like so:

```JavaScript
const Layout () => (
    <>
        <Fonts/>
    </>
)
```

Now, with all of this set-up anywhere we want to use one of these fonts in our styling we can do so with:

```css
p {
    font-family: 'Roboto', sans-serif;
    font-weight 400;
}
```

#### Vanilla CSS

Creating the font faces for our fonts using vanilla CSS is largely the same as with Styled Components minus the external component parts, instead we will be putting all of the information inside a global CSS file. For our example we just need to include the below in our css file:

```css
@font-face {
    font-family: 'Roboto';
    src: url(src/assets/fonts/Roboto-Regular.woff2) format('woff2');
    font-weight: 400;
    font-style: normal;
  }
  @font-face {
    font-family: 'Roboto';
    src: url(src/assets/fonts/Roboto-Medium.woff2) format('woff2');
    font-weight: 500;
    font-style: normal;
  } 
  @font-face {
    font-family: 'Roboto';
    src: url(src/assets/fonts/Roboto-Bold.woff2) format('woff2');
    font-weight: 700;
    font-style: normal;
  }
```

With these imported into our global css file, we just need to include our global css file in our gatsby-browser.js file to import it for our site to use the styles and then we're done, you should now have access to all of your new fonts on your site using:

```css
p {
    font-family: 'Roboto', sans-serif;
    font-weight 400;
}
```

## Conclusion

Using this method, we are able to load only the fonts we need and serve them locally from our server cutting down any external load times without having to worry about importing any external packages and bloating our package size. Using this way of importing Google Fonts helped me increase the performance greatly as shown in the speed tests at the top of this post, this is was also reflected in my Lighthouse audit score. 

Finally, it's worth mentioning if you need to support older browsers you may need to src other file file types than 'woff2' but all modern browsers support this font file type. I will leave the decision up to you if you need to use other file types or not but you can find more info on what does and doesn't support this format [here](https://caniuse.com/woff2).

Honestly, although this method takes more set-up then the external packages I prefer it for the control it gives us along with the performance and bundle size advantages it gives us. 

I'm curious to know, will you adopt this way of importing Google Fonts on your GatsbyJS site? Or, will you use one of the external packages? Or, something else altogether? Make sure to let me know over on Twitter [@MrConerMurphy](https://twitter.com/MrConerMurphy).

